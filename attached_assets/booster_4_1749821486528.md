# Analysis of Booster Usage and Next-Day Retention

This document outlines the step-by-step process used to answer the question: **"Does heavy booster usage improve next‑day retention?"**

## 1. Defining the Question and Hypothesis

The goal of this analysis is to determine if players who use a large number of boosters are more likely to play the game again the following day.

*   **Heavy Users:** Players who used ≥ 10 boosters on a given day.
*   **Light Users:** Players who used < 10 boosters on a given day.
*   **Null Hypothesis (H0):** The next-day retention rate for heavy users is less than or equal to the rate for light users. `p(retained | heavy) ≤ p(retained | light)`
*   **Alternative Hypothesis (H1):** The next-day retention rate for heavy users is greater than the rate for light users. `p(retained | heavy) > p(retained | light)`

To test the difference between these two proportions, a **two-proportion z-test** was selected as the appropriate statistical method.

## 2. Data Extraction and Preparation

The data was prepared in two main SQL stages. First, we calculated the total boosters used by each player on each day of activity. Second, we determined if each player returned to play on the subsequent day.

### Step 2.1: Calculating Daily Booster Usage

This query aggregates game data to count the total number of boosters used by each user, per day. The results were saved to the table `xgcrypt.bp.daily_booster_usage`.

```sql
SELECT
    user_id,
    active_date,
    SUM(
      CASE
        WHEN j.element.player_booster_activate IS NULL
          OR j.element.player_booster_activate = ''
        THEN 0
        ELSE ARRAY_LENGTH(SPLIT(j.element.player_booster_activate, ':'))
      END
    ) AS daily_total_boosters
  FROM `bp.data3m`
  CROSS JOIN UNNEST(game_end_v2.list) AS j
  WHERE
    j.element.game_type = 'pvp'
    AND j.element.boosters IS NOT NULL
    AND j.element.boosters != ''
    AND j.element.boosters != '[]'
  GROUP BY user_id, active_date
```

### Step 2.2: Determining Next-Day Retention

Using the daily booster usage data, this query determines whether each user was active on the following day. The `LEAD()` window function is used to find the next active day for each user. The results were saved to `xgcrypt.bp.next_day_retention_bstr_usage`.

```sql
SELECT
  user_id,
  active_date,
  daily_total_boosters,
  CASE
    WHEN DATE_DIFF(next_active_date, active_date, DAY) = 1 THEN TRUE
    ELSE FALSE
  END AS active_next_day
FROM (
  SELECT
    user_id,
    active_date,
    daily_total_boosters,
    LEAD(active_date) OVER (PARTITION BY user_id ORDER BY active_date) AS next_active_date
  FROM
    xgcrypt.bp.daily_booster_usage
)
```
A sample of the resulting table `next_day_retention_bstr_usage` looks like this:

| Row | user_id                    | active_date | daily_total_boosters | active_next_day |
|-----|----------------------------|-------------|----------------------|-----------------|
| 1   | 2YjcqoqbpJTlfeSgEcVl0KfsDwB3 | 2025-03-11  | 6                    | false           |


## 3. Statistical Analysis: Two-Proportion Z-Test

A Python script was used to query the final table, calculate the proportions, and perform the z-test.

### Python Script (`questions/code/retention_z_test.py`)
```python
import os
from google.cloud import bigquery
from statsmodels.stats.proportion import proportions_ztest

# Set the path to your service account key file
os.environ["GOOGLE_APPLICATION_CREDENTIALS"] = "bq-readonly-bp-key.json"

# Initialize the BigQuery client
client = bigquery.Client()

# Define your query to get the counts for heavy and light users
query = \"\"\"
WITH user_groups AS (
  SELECT
    CASE
      WHEN daily_total_boosters >= 10 THEN 'heavy'
      ELSE 'light'
    END AS user_group,
    active_next_day
  FROM
    `xgcrypt.bp.next_day_retention_bstr_usage`
)
SELECT
  user_group,
  COUNTIF(active_next_day IS TRUE) AS retained_count,
  COUNT(*) AS total_count
FROM
  user_groups
GROUP BY
  user_group
\"\"\"

# Run the query
query_job = client.query(query)
results = query_job.result()

# Process the results
counts = {}
for row in results:
    counts[row['user_group']] = {
        'retained': row['retained_count'],
        'total': row['total_count']
    }

heavy_retained = counts.get('heavy', {}).get('retained', 0)
heavy_total = counts.get('heavy', {}).get('total', 0)
light_retained = counts.get('light', {}).get('retained', 0)
light_total = counts.get('light', {}).get('total', 0)

# Perform the two-proportion z-test
stat, p_value = proportions_ztest(
    count=[heavy_retained, light_retained],
    nobs=[heavy_total, light_total],
    alternative='larger'
)

print("Two-proportion z-test results:")
print(f"Z-statistic: {stat}")
print(f"P-value: {p_value}")

# Interpretation of the results
alpha = 0.05
if p_value < alpha:
    print("The null hypothesis is rejected. Heavy booster usage is associated with a higher next-day retention rate.")
else:
    print("The null hypothesis cannot be rejected. There is not enough evidence to say that heavy booster usage improves next-day retention.")

print(f"\\nHeavy users (>= 10 boosters/day): {heavy_retained} retained out of {heavy_total}")
print(f"Light users (< 10 boosters/day): {light_retained} retained out of {light_total}")

if heavy_total > 0:
    heavy_retention_rate = (heavy_retained / heavy_total) * 100
    print(f"Heavy user retention rate: {heavy_retention_rate:.2f}%")

if light_total > 0:
    light_retention_rate = (light_retained / light_total) * 100
    print(f"Light user retention rate: {light_retention_rate:.2f}%")
```

## 4. Results and Conclusion

The script produced the following output:
```
Two-proportion z-test results:
Z-statistic: 138.87420778746403
P-value: 0.0
The null hypothesis is rejected. Heavy booster usage is associated with a higher next-day retention rate.

Heavy users (>= 10 boosters/day): 36472 retained out of 100352
Light users (< 10 boosters/day): 181553 retained out of 1005615
Heavy user retention rate: 36.34%
Light user retention rate: 18.05%
```

*   **Z-statistic:** `138.87` - The large positive z-statistic indicates that the retention rate for heavy users is significantly higher than for light users.
*   **P-value:** `0.0` - The p-value is effectively zero, providing overwhelming evidence against the null hypothesis.

**Conclusion:** We reject the null hypothesis. There is a strong, statistically significant association between heavy booster usage and next-day retention. Players who use 10 or more boosters are about twice as likely to return the next day (36.3% retention) compared to those who use fewer (18.1% retention). 